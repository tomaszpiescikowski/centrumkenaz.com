# Backend API proxy locations – included in every server block
# that needs to reach the FastAPI backend.
#
# Usage:  include /etc/nginx/snippets/kenaz-backend.conf;

# Prevent Cloudflare (and any other CDN/proxy) from transforming responses,
# e.g. email address obfuscation that replaces real emails with [email protected]
add_header Cache-Control "no-transform" always;

# /auth/callback and /auth/error are frontend SPA routes — must NOT be proxied
# to the backend.  Exact-matches have higher priority than the prefix /auth/ below.
location = /auth/callback { try_files /index.html =404; }
location = /auth/error    { try_files /index.html =404; }

# Core API endpoints
location /auth/    { proxy_pass http://127.0.0.1:8000/auth/;    include /etc/nginx/proxy_params; }
location /events/  { proxy_pass http://127.0.0.1:8000/events/;  include /etc/nginx/proxy_params; }
location /payments/       { proxy_pass http://127.0.0.1:8000/payments/;       include /etc/nginx/proxy_params; }
location /users/          { proxy_pass http://127.0.0.1:8000/users/;          include /etc/nginx/proxy_params; }
location /registrations/  { proxy_pass http://127.0.0.1:8000/registrations/;  include /etc/nginx/proxy_params; }
location /products/       { proxy_pass http://127.0.0.1:8000/products/;       include /etc/nginx/proxy_params; }
location /uploads/        { proxy_pass http://127.0.0.1:8000/uploads/;        include /etc/nginx/proxy_params; }
location /cities/         { proxy_pass http://127.0.0.1:8000/cities/;         include /etc/nginx/proxy_params; }
location /comments/       { proxy_pass http://127.0.0.1:8000/comments/;       include /etc/nginx/proxy_params; }
location /donations/      { proxy_pass http://127.0.0.1:8000/donations/;      include /etc/nginx/proxy_params; }
location = /event-types   { proxy_pass http://127.0.0.1:8000/event-types;     include /etc/nginx/proxy_params; }
location /event-types/    { proxy_pass http://127.0.0.1:8000/event-types/;    include /etc/nginx/proxy_params; }
location = /push/vapid-public-key { proxy_pass http://127.0.0.1:8000/push/vapid-public-key; include /etc/nginx/proxy_params; }
location /push/           { proxy_pass http://127.0.0.1:8000/push/;           include /etc/nginx/proxy_params; }
location /api/            { proxy_pass http://127.0.0.1:8000/api/;            include /etc/nginx/proxy_params; }

# Admin API endpoints — only proxy known backend sub-paths so that
# SPA routes like /admin/events/new and /admin/icons are handled by
# the catch-all "location /" → try_files → index.html fallback.
location /admin/stats/                  { proxy_pass http://127.0.0.1:8000/admin/stats/;                  include /etc/nginx/proxy_params; }
location /admin/users/                  { proxy_pass http://127.0.0.1:8000/admin/users/;                  include /etc/nginx/proxy_params; }
location /admin/manual-payments/        { proxy_pass http://127.0.0.1:8000/admin/manual-payments/;        include /etc/nginx/proxy_params; }
location /admin/subscription-purchases/ { proxy_pass http://127.0.0.1:8000/admin/subscription-purchases/; include /etc/nginx/proxy_params; }
location = /admin/promote-admin         { proxy_pass http://127.0.0.1:8000/admin/promote-admin;           include /etc/nginx/proxy_params; }

# Utility / docs
location = /health       { proxy_pass http://127.0.0.1:8000/health;       include /etc/nginx/proxy_params; }
location = /docs         { proxy_pass http://127.0.0.1:8000/docs;         include /etc/nginx/proxy_params; }
location = /redoc        { proxy_pass http://127.0.0.1:8000/redoc;        include /etc/nginx/proxy_params; }
location = /openapi.json { proxy_pass http://127.0.0.1:8000/openapi.json; include /etc/nginx/proxy_params; }
