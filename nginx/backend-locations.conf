# Backend API proxy locations - included in every server block
# that needs to reach the FastAPI backend.
#
# Usage:  include /etc/nginx/snippets/kenaz-backend.conf;

# Prevent Cloudflare (and any other CDN/proxy) from transforming responses,
# e.g. email address obfuscation that replaces real emails with example@example.com
add_header Cache-Control "no-transform" always;

# /auth/callback and /auth/error are frontend SPA routes - must NOT be proxied
# to the backend.
location = /auth/callback { try_files /index.html =404; }
location = /auth/error    { try_files /index.html =404; }

# WebSocket upgrade for real-time chat notifications
# Must appear BEFORE the generic /api/ block.
# Note: proxy_params includes proxy_http_version 1.1, so we set it here
# explicitly and omit the include to avoid a duplicate-directive error.
location /api/comments/ws {
    proxy_pass http://127.0.0.1:8000/api/comments/ws;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
}

# All API traffic - single block covers every router now under /api/ prefix
location /api/ { proxy_pass http://127.0.0.1:8000/api/; include /etc/nginx/proxy_params; }

# Static uploads served by FastAPI StaticFiles (not under /api/)
location /uploads/ { proxy_pass http://127.0.0.1:8000/uploads/; include /etc/nginx/proxy_params; }

# Utility / docs
location = /health       { proxy_pass http://127.0.0.1:8000/health;       include /etc/nginx/proxy_params; }
location = /docs         { proxy_pass http://127.0.0.1:8000/docs;         include /etc/nginx/proxy_params; }
location = /redoc        { proxy_pass http://127.0.0.1:8000/redoc;        include /etc/nginx/proxy_params; }
location = /openapi.json { proxy_pass http://127.0.0.1:8000/openapi.json; include /etc/nginx/proxy_params; }
