# Backend API proxy locations - included in every server block
# that needs to reach the FastAPI backend.
#
# Usage:  include /etc/nginx/snippets/kenaz-backend.conf;

# Prevent Cloudflare (and any other CDN/proxy) from transforming responses,
# e.g. email address obfuscation that replaces real emails with example@example.com
add_header Cache-Control "no-transform" always;

# /auth/callback and /auth/error are frontend SPA routes - must NOT be proxied
# to the backend.
location = /auth/callback { try_files /index.html =404; }
location = /auth/error    { try_files /index.html =404; }

# All API traffic - single block covers every router now under /api/ prefix
location /api/ { proxy_pass http://127.0.0.1:8000/api/; include /etc/nginx/proxy_params; }

# Static uploads served by FastAPI StaticFiles (not under /api/)
location /uploads/ { proxy_pass http://127.0.0.1:8000/uploads/; include /etc/nginx/proxy_params; }

# Utility / docs
location = /health       { proxy_pass http://127.0.0.1:8000/health;       include /etc/nginx/proxy_params; }
location = /docs         { proxy_pass http://127.0.0.1:8000/docs;         include /etc/nginx/proxy_params; }
location = /redoc        { proxy_pass http://127.0.0.1:8000/redoc;        include /etc/nginx/proxy_params; }
location = /openapi.json { proxy_pass http://127.0.0.1:8000/openapi.json; include /etc/nginx/proxy_params; }
