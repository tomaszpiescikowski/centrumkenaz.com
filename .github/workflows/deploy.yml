name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        type: boolean
        default: false

concurrency:
  group: production-deployment
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.14'
  APP_DIR: /opt/kenaz
  BACKEND_DIR: /opt/kenaz/backend
  FRONTEND_DIR: /opt/kenaz/dist
  STATIC_DIR: /opt/kenaz/static

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Check required secrets
        run: |
          MISSING=0

          check_secret() {
            local name="$1"
            local value="$2"
            if [ -z "$value" ]; then
              echo "‚ùå $name secret is not set"
              MISSING=1
            fi
          }

          # Infrastructure
          check_secret "SSH_HOST" "${{ secrets.SSH_HOST }}"
          check_secret "SSH_USER" "${{ secrets.SSH_USER }}"
          check_secret "SSH_PRIVATE_KEY" "${{ secrets.SSH_PRIVATE_KEY }}"

          # Application secrets
          check_secret "DATABASE_URL" "${{ secrets.DATABASE_URL }}"
          check_secret "JWT_SECRET_KEY" "${{ secrets.JWT_SECRET_KEY }}"
          check_secret "GOOGLE_CLIENT_ID" "${{ secrets.GOOGLE_CLIENT_ID }}"
          check_secret "GOOGLE_CLIENT_SECRET" "${{ secrets.GOOGLE_CLIENT_SECRET }}"

          if [ "$MISSING" -eq 1 ]; then
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Check required variables
        run: |
          MISSING=0

          check_var() {
            local name="$1"
            local value="$2"
            if [ -z "$value" ]; then
              echo "‚ö†Ô∏è  $name variable is not set (will use default)"
            fi
          }

          # These are optional but recommended for production
          check_var "APP_SCHEME" "${{ vars.APP_SCHEME }}"
          check_var "APP_HOST" "${{ vars.APP_HOST }}"
          check_var "DEFAULT_PAYMENT_URL" "${{ vars.DEFAULT_PAYMENT_URL }}"
          check_var "ROOT_ADMIN_EMAIL" "${{ vars.ROOT_ADMIN_EMAIL }}"

          echo "‚úÖ Variable check completed"

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: kenaz_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        env:
          VITE_API_URL: ""
          VITE_DEFAULT_PAYMENT_URL: ${{ vars.DEFAULT_PAYMENT_URL }}
        run: npm run build

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Run backend tests
        if: ${{ !inputs.skip_tests }}
        env:
          DATABASE_URL_TEST: postgresql+asyncpg://postgres:postgres@localhost:5432/kenaz_test
          ROOT_ADMIN_EMAIL: ${{ vars.ROOT_ADMIN_EMAIL }}
        run: |
          cd backend
          pytest tests/ -v --tb=short

      - name: Validate Alembic migration files
        run: |
          cd backend
          echo "Checking migration chain consistency..."
          python -m alembic heads | grep -q ' (head)' && echo "‚úÖ Single migration head found" || { echo "‚ùå Multiple or missing migration heads"; exit 1; }
          python -m alembic branches | grep -q 'No branches' && echo "‚úÖ No divergent branches" || echo "‚ö†Ô∏è  Warning: Divergent migration branches detected"

  deploy:
    name: Deploy to Lightsail
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add host to known_hosts
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Create SSH config
          cat >> ~/.ssh/config <<EOF
          Host deploy-server
            HostName ${{ secrets.SSH_HOST }}
            User ${{ secrets.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking accept-new
            ServerAliveInterval 60
            ServerAliveCountMax 3
          EOF
          
          chmod 600 ~/.ssh/config

      - name: Test SSH connection
        run: |
          echo "Testing SSH connection..."
          ssh deploy-server "echo '‚úÖ SSH connection successful' && whoami && uname -a"

      - name: Backup current deployment
        run: |
          ssh deploy-server <<'ENDSSH'
          set -euo pipefail
          if [ -f "${{ env.BACKEND_DIR }}/main.py" ] || [ -f "${{ env.FRONTEND_DIR }}/index.html" ]; then
            BACKUP_DIR="/opt/kenaz-backup-$(date +%Y%m%d-%H%M%S)"
            echo "Creating backup at $BACKUP_DIR..."
            sudo rsync -a \
              --exclude 'backend/venv/' \
              --exclude 'backend/__pycache__/' \
              --exclude 'backend/.pytest_cache/' \
              ${{ env.APP_DIR }}/ $BACKUP_DIR/
            echo "‚úÖ Backup created: $BACKUP_DIR"
            # Keep only last 3 backups
            sudo ls -dt /opt/kenaz-backup-* 2>/dev/null | tail -n +4 | xargs -r sudo rm -rf
          else
            echo "‚ÑπÔ∏è  First deployment, no backup needed"
          fi
          ENDSSH

      - name: Create deployment directories
        run: |
          ssh deploy-server <<'ENDSSH'
          set -euo pipefail
          echo "Creating deployment directories..."
          sudo mkdir -p ${{ env.APP_DIR }}
          sudo mkdir -p ${{ env.BACKEND_DIR }}
          sudo mkdir -p ${{ env.FRONTEND_DIR }}
          sudo mkdir -p ${{ env.STATIC_DIR }}
          sudo chown -R $USER:$USER ${{ env.APP_DIR }}
          echo "‚úÖ Directories created"
          ENDSSH

      - name: Sync backend files
        run: |
          echo "Syncing backend files..."
          rsync -avz --delete \
            --exclude '.git/' \
            --exclude '__pycache__/' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude '.env.*' \
            --exclude '.env.example' \
            --exclude 'venv/' \
            --exclude '.pytest_cache/' \
            --exclude '.mypy_cache/' \
            --exclude '*.db' \
            --exclude '*.db-shm' \
            --exclude '*.db-wal' \
            --exclude '.coverage' \
            --exclude 'static/uploads/' \
            --exclude 'tests/' \
            --exclude 'pytest.ini' \
            --exclude 'TESTING.md' \
            backend/ deploy-server:${{ env.BACKEND_DIR }}/
          echo "‚úÖ Backend files synced"

      - name: Sync frontend files
        run: |
          echo "Syncing frontend files..."
          rsync -avz --delete \
            dist/ deploy-server:${{ env.FRONTEND_DIR }}/
          echo "‚úÖ Frontend files synced"

      - name: Sync static files
        run: |
          echo "Syncing static files..."
          rsync -avz --delete \
            public/static/ deploy-server:${{ env.STATIC_DIR }}/
          echo "‚úÖ Static files synced"

      - name: Clean stale files from server
        run: |
          ssh deploy-server <<'ENDSSH'
          set -euo pipefail
          echo "Cleaning stale files from deployment root..."
          cd ${{ env.APP_DIR }}

          # Allowed top-level entries in /opt/kenaz/
          ALLOWED="backend dist static logs"

          for item in *; do
            KEEP=false
            for allowed in $ALLOWED; do
              if [ "$item" = "$allowed" ]; then
                KEEP=true
                break
              fi
            done
            if [ "$KEEP" = "false" ]; then
              echo "  Removing stale: $item"
              rm -rf "$item"
            fi
          done

          # Also remove hidden files/dirs that shouldn't be there (except .env in backend)
          for item in .[!.]* ..?*; do
            [ -e "$item" ] || continue
            echo "  Removing stale hidden: $item"
            rm -rf "$item"
          done

          # Ensure logs dir exists
          mkdir -p logs
          # Ensure uploads dir exists
          mkdir -p backend/static/uploads

          echo "‚úÖ Server root cleaned"
          ENDSSH

      - name: Setup Python environment
        run: |
          ssh deploy-server <<'ENDSSH'
          set -euo pipefail
          cd ${{ env.BACKEND_DIR }}
          
          echo "Checking Python version..."
          if ! command -v ~/.local/bin/python3.14 &> /dev/null; then
            echo "‚ùå Python 3.14 not found at ~/.local/bin/python3.14"
            echo "Install from source: https://www.python.org/downloads/"
            exit 1
          fi
          
          echo "Setting up virtual environment..."
          if [ -d venv ]; then
            VENV_VERSION=$(venv/bin/python --version 2>&1 | grep -oP '\d+\.\d+' | head -1)
            if [ "$VENV_VERSION" != "3.14" ]; then
              echo "Removing old venv (Python $VENV_VERSION)..."
              rm -rf venv
            fi
          fi
          
          if [ ! -d venv ]; then
            echo "Creating new virtual environment..."
            ~/.local/bin/python3.14 -m venv venv
          fi
          
          echo "Installing dependencies..."
          venv/bin/pip install --upgrade pip
          venv/bin/pip install -r requirements.txt
          
          echo "‚úÖ Python environment ready"
          ENDSSH

      - name: Generate backend .env
        run: |
          ssh deploy-server "cat > ${{ env.BACKEND_DIR }}/.env << 'DOTENV'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          TPAY_CLIENT_ID=${{ secrets.TPAY_CLIENT_ID }}
          TPAY_CLIENT_SECRET=${{ secrets.TPAY_CLIENT_SECRET }}
          APP_SCHEME=${{ vars.APP_SCHEME || 'https' }}
          APP_HOST=${{ vars.APP_HOST || 'localhost' }}
          PAYMENT_GATEWAY_TYPE=${{ vars.PAYMENT_GATEWAY_TYPE || 'fake' }}
          DEFAULT_PAYMENT_URL=${{ vars.DEFAULT_PAYMENT_URL }}
          ROOT_ADMIN_EMAIL=${{ vars.ROOT_ADMIN_EMAIL }}
          DEBUG=${{ vars.DEBUG || 'false' }}
          DOTENV
          "
          ssh deploy-server "chmod 600 ${{ env.BACKEND_DIR }}/.env"
          echo "‚úÖ .env generated on server"

      - name: Run database migrations
        run: |
          ssh deploy-server <<'ENDSSH'
          set -euo pipefail
          cd ${{ env.BACKEND_DIR }}
          
          echo "Running database migrations..."
          CURRENT=$(venv/bin/alembic current 2>&1 || true)
          HEAD=$(venv/bin/alembic heads 2>&1 | awk '{print $1}')
          if echo "$CURRENT" | grep -q "Can't locate revision"; then
            echo "‚ö†Ô∏è  Database points to unknown revision ‚Äî fixing alembic_version table directly"
            # Source DB URL from .env and update alembic_version via psql
            DB_URL=$(grep -E '^DATABASE_URL=' .env | cut -d'=' -f2- | tr -d '"' | tr -d "'")
            if [ -z "$DB_URL" ]; then
              DB_URL=$(grep -E '^SQLALCHEMY_DATABASE_URL=' .env | cut -d'=' -f2- | tr -d '"' | tr -d "'")
            fi
            echo "Updating alembic_version to $HEAD..."
            psql "$DB_URL" -c "UPDATE alembic_version SET version_num = '$HEAD';"
            echo "‚úÖ alembic_version stamped to $HEAD"
          fi
          venv/bin/alembic upgrade head
          echo "‚úÖ Migrations completed"
          ENDSSH

      - name: Restart backend service
        run: |
          ssh deploy-server <<'ENDSSH'
          set -euo pipefail
          
          echo "Restarting backend service..."
          sudo systemctl restart kenaz-backend
          
          echo "Waiting for service to start..."
          sleep 3
          
          if sudo systemctl is-active --quiet kenaz-backend; then
            echo "‚úÖ Backend service is running"
          else
            echo "‚ùå Backend service failed to start"
            sudo systemctl status kenaz-backend --no-pager
            exit 1
          fi
          ENDSSH

      - name: Reload nginx
        run: |
          ssh deploy-server <<'ENDSSH'
          set -euo pipefail
          
          echo "Testing nginx configuration..."
          sudo nginx -t
          
          echo "Reloading nginx..."
          sudo systemctl reload nginx
          
          if sudo systemctl is-active --quiet nginx; then
            echo "‚úÖ Nginx reloaded successfully"
          else
            echo "‚ùå Nginx failed to reload"
            sudo systemctl status nginx --no-pager
            exit 1
          fi
          ENDSSH

      - name: Health check
        run: |
          echo "Performing health check..."
          sleep 5
          
          # Check if backend is responding
          HEALTH_URL="http://${{ secrets.SSH_HOST }}/docs"
          for i in {1..5}; do
            if curl -f -s -o /dev/null "$HEALTH_URL"; then
              echo "‚úÖ Health check passed: $HEALTH_URL"
              exit 0
            fi
            echo "Attempt $i/5 failed, waiting..."
            sleep 3
          done
          
          echo "‚ùå Health check failed after 5 attempts"
          echo "Check manually: $HEALTH_URL"
          exit 1

      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è  Deployment failed ‚Äî attempting rollback..."
          LATEST_BACKUP=$(ssh deploy-server "sudo ls -dt /opt/kenaz-backup-* 2>/dev/null | head -1" || true)
          if [ -n "$LATEST_BACKUP" ]; then
            ssh deploy-server <<ENDSSH
          set -euo pipefail
          echo "Restoring from $LATEST_BACKUP..."

          # Restore backend code (preserve venv and .env)
          if [ -d "$LATEST_BACKUP/backend" ]; then
            rsync -a --delete \
              --exclude 'venv/' \
              --exclude '.env' \
              $LATEST_BACKUP/backend/ ${{ env.BACKEND_DIR }}/
          fi

          # Restore frontend
          if [ -d "$LATEST_BACKUP/dist" ]; then
            rsync -a --delete $LATEST_BACKUP/dist/ ${{ env.FRONTEND_DIR }}/
          fi

          # Restore static (preserve uploads)
          if [ -d "$LATEST_BACKUP/static" ]; then
            rsync -a $LATEST_BACKUP/static/ ${{ env.STATIC_DIR }}/
          fi

          sudo chown -R \$USER:\$USER ${{ env.APP_DIR }}
          sudo systemctl restart kenaz-backend
          sudo systemctl reload nginx
          echo "‚úÖ Rollback completed"
          ENDSSH
          else
            echo "‚ùå No backup found for rollback"
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          echo "‚úÖ Cleanup completed"

      - name: Deployment summary
        if: success()
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üöÄ Deployment completed successfully!"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
